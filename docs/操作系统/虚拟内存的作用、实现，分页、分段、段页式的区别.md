# 虚拟内存的作用、实现，分页、分段的区别

## 1. 虚拟内存的作用

- 虚拟内存其实是将内存看作是磁盘的高速缓存。内存只保存活动区域，其间，根据需要在磁盘和内存之间来回传递数据（即页面置换算法），高效使用内存
- 为每个进程提供了一个一致的、私有的、连续的地址，让每个进程都以为自己在独占内存，简化了编码者对存储器的管理
- 提供了进程间的隔离性，防止进程写了其他进程的内存空间，导致莫名其妙的错误出现，保护每个进程的数据空间不被其他进程破坏，进行数据隔离

## 2. 虚拟内存的实现

为了达到以上的三个作用，虚拟内存需要两个维度的支持来实现：

一个维度是硬件支持

- 一定容量的内存和外存
- 页表机制（或段表机制）
- 中断机制，当用户程序需要访问的地址尚未调入内存，则产生中断
- 地址转换机制，虚拟地址与物理地址的映射

另一方面，有了这些硬件支持后，我们可以有多种方式进行虚拟地址和物理地址的映射，也就是操作系统课本上总是出现的：分段、分页和段页式，也是大家总是分不清的几个词。

用最通俗易懂的方式来讲

- 分段

  - 问题引出： 地址空间不隔离，某进程不小心修改到另一个进程的地址空间，导致奇怪的bug出现

  - 简述作用：**为了实现地址隔离**，编码者希望在编码时不会误操作其他进程的地址

  - 具体实现：分段式把连续虚拟地址空间划分为若干个段，每个段从0开始编址，并映射到连续物理地址空间，你写的程序操作的是虚拟地址空间，当你的程序运行时，需要把整段连续的虚拟地址，映射到内存中连续的物理地址。

    这时，你只能操控你的进程所分配到的虚拟地址，就实现了地址隔离。

- 分页

  - 问题引出：分段的粒度为整个程序的不同段（如代码段、数据段）的虚拟内存是一个整体，在内存和磁盘间换进换出。而实际上在程序运行过程中，并不需要把它的整个段都放入内存，只需要把CPU当前使用到的代码、数据等放在内存中，假设有两个程序，一个70M，另一个40M，你有一块100M的辣鸡内存，如果按分段来运行，一次只能运行一个程序，放进了70M的程序进内存运行，但其实还有30M，你明明可以把另一个程序的一部分拿进来运行，但分段不允许你这么做，这时候，分页系统就出现了！

  - 简述作用：**使得进程的物理地址空间可以是非连续的**

  - 具体实现：分页，将虚拟地址划分为固定大小的区域，称为页；物理地址分为同样大小固定的区域，称为块（帧）。可将用户程序的任一页放在任一块。 通过页面，页号，偏移量寻址（映射）

    当然了，分页时你的进程的虚拟地址空间仍然是连续的，但是这段虚拟地址空间所映射到的物理地址空间就不一定连续了。
